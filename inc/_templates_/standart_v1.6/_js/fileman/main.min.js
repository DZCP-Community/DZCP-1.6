function selectFile(e){$("#pnlFileList li").removeClass("selected"),$(e).prop("class","selected");var i=RoxyUtils.GetFilename($(e).attr("data-path"));i+=" ("+t("Size")+": "+RoxyUtils.FormatFileSize($(e).attr("data-size")),$(e).attr("data-w")>0&&(i+=", "+t("Dimensions")+":"+$(e).attr("data-w")+"x"+$(e).attr("data-h")),i+=")",$("#pnlStatus").html(i)}function getLastDir(){return RoxyUtils.GetCookie("roxyld")}function setLastDir(e){RoxyUtils.SetCookie("roxyld",e,10)}function selectDir(e){var t=Directory.Parse($(e).parent("li").attr("data-path"));t&&t.Select()}function startDragDir(){}function startDragFile(){selectFile(this)}function dragFileOver(){$(this).children("img.dir").attr("src","images/fileman/folder-green.png")}function dragFileOut(){$("#pnlDirList").find("img.dir").attr("src","images/fileman/folder.png")}function makeDragFile(e){var t=new File($(e.target).closest("li").attr("data-path"));return'<div class="pnlDragFile" data-path="'+t.fullPath+'"><img src="'+t.bigIcon+'" align="absmiddle">&nbsp;'+t.name+"</div>"}function makeDragDir(e){var t=new Directory($(e.target).attr("data-path")?$(e.target).attr("data-path"):$(e.target).closest("li").attr("data-path"));return'<div class="pnlDragDir" data-path="'+t.fullPath+'"><img src="images/fileman/folder.png" align="absmiddle">&nbsp;'+t.name+"</div>"}function moveDir(e,t,i){var l=Directory.Parse(t.draggable.attr("data-path")),a=Directory.Parse($(i).parent("li").attr("data-path"));a.fullPath!=l.path&&l.Move(a.fullPath)}function moveFile(e,t,i){var l=new File(t.draggable.attr("data-path")),a=Directory.Parse($(i).parent("li").attr("data-path"));Directory.Parse(l.path);l.path!=a.fullPath&&l.Move(a.fullPath)}function moveObject(e,t){e.stopPropagation(),t.draggable.hasClass("directory")?moveDir(e,t,this):moveFile(e,t,this),dragFileOut()}function clickFirstOnEnter(e){$("#"+e).unbind("keypress"),$(".actions input").each(function(){this.blur()}),$("#"+e).keypress(function(e){e.keyCode==$.ui.keyCode.ENTER&&(e.stopPropagation(),$(this).parent().find(".ui-dialog-buttonset button").eq(0).trigger("click"))})}function addDir(){var e=getSelectedDir();if(e){clickFirstOnEnter("pnlDirName"),$("#txtDirName").val("");var i={};i[t("CreateDir")]=function(){var i=$.trim($("#txtDirName").val());i||alert(t("E_MissingDirName")),e.Create(i)&&$("#pnlDirName").dialog("close")},i[t("Cancel")]=function(){$("#pnlDirName").dialog("close")},$("#pnlDirName").dialog({title:t("T_CreateDir"),modal:!0,buttons:i})}}$.ajaxSetup({cache:!1});var uploadFileList=new Array;function showUploadList(e){var t=$("#uploadFilesList");for(t.html(""),clearFileField(),i=0;i<e.length;i++)t.append('<div class="fileUpload"><div class="fileName">'+e[i].name+" ("+RoxyUtils.FormatFileSize(e[i].size)+')<span class="progressPercent"></span><div class="uploadProgress"><div class="stripes"></div></div></div><a class="removeUpload" onclick="removeUpload('+i+')"></a></div>');e.length>0?$("#btnUpload").button("enable"):$("#btnUpload").button("disable")}function listUploadFiles(e){window.FileList?e.length>0&&(uploadFileList=new Array,addUploadFiles(e)):$("#btnUpload").button("enable")}function addUploadFiles(e){for(i=0;i<e.length;i++)uploadFileList.push(e[i]);showUploadList(uploadFileList)}function removeUpload(e){findUploadElement(e).remove();try{uploadFileList.splice(e,1),showUploadList(uploadFileList)}catch(e){}}function findUploadElement(e){return $("#uploadFilesList .fileUpload:eq("+e+")")}function updateUploadProgress(e,t){var i=findUploadElement(t),l=99;e.lengthComputable&&(l=Math.floor(e.loaded/e.total*100)),l>99&&(l=99),i.find(".uploadProgress").css("width",l+"%"),i.find(".progressPercent").html(" - "+l+"%")}function uploadComplete(e,t){uploadFinished(e,t,"ok")}function uploadError(e,t){setUploadError(t,""),uploadFinished(e,t,"error")}function setUploadError(e,t){var i=findUploadElement(e);i.find(".uploadProgress").css("width","100%").addClass("uploadError").removeClass("uploadComplete"),i.find(".progressPercent").html(' - <span class="error">'+t+"</span>")}function setUploadSuccess(e){var t=findUploadElement(e);t.find(".uploadProgress").css("width","100%").removeClass("uploadError").addClass("uploadComplete"),t.find(".progressPercent").html(" - 100%")}function uploadCanceled(e,t){uploadFinished(e,t,"error")}function uploadFinished(e,t,i){var l=findUploadElement(t),a=null;try{a=JSON.parse(e.target.responseText)}catch(e){}a&&"error"==a.res||"ok"!=i?(i="error",setUploadError(t,a.msg)):(i="ok",setUploadSuccess(t)),l.attr("data-ulpoad",i),checkUploadResult()}function checkUploadResult(){var e=$("#uploadFilesList .fileUpload").length,t=$("#uploadFilesList .fileUpload[data-ulpoad]").length;$('#uploadFilesList .fileUpload[data-ulpoad="ok"]').length;t==e&&(uploadFileList=new Array,Directory.Parse($("#hdDir").val()).ListFiles(!0),$("#btnUpload").button("disable"))}function fileUpload(e,t){var i=new XMLHttpRequest,l=new FormData;findUploadElement(t).find(".removeUpload").remove(),l.append("action","upload"),l.append("method","ajax"),l.append("d",$("#hdDir").attr("value")),l.append("files[]",e),i.upload.addEventListener("progress",function(e){updateUploadProgress(e,t)},!1),i.addEventListener("load",function(e){uploadComplete(e,t)},!1),i.addEventListener("error",function(e){uploadError(e,t)},!1),i.addEventListener("abort",function(e){uploadCanceled(e,t)},!1),i.open("POST",RoxyFilemanConf.UPLOAD,!0),i.setRequestHeader("Accept","*/*"),i.send(l)}function dropFiles(e,t){e&&e.dataTransfer&&e.dataTransfer.files?(addFile(),t?addUploadFiles(e.dataTransfer.files):listUploadFiles(e.dataTransfer.files)):addFile()}function clearFileField(e){e||(e="#fileUploads");try{$(e).val(""),$(e).val(null)}catch(e){}}function addFileClick(){$("#uploadResult").html(""),showUploadList(new Array),addFile()}function addFile(){clickFirstOnEnter("dlgAddFile"),$("#uploadResult").html(""),clearFileField();var e={};e[t("Upload")]={id:"btnUpload",text:t("Upload"),disabled:!0,click:function(){if($("#fileUploads").val()||uploadFileList&&0!=uploadFileList.length)if(RoxyFilemanConf.UPLOAD)if(window.FormData&&window.XMLHttpRequest&&window.FileList&&uploadFileList&&uploadFileList.length>0)for(i=0;i<uploadFileList.length;i++)fileUpload(uploadFileList[i],i);else document.forms.addfile.action=RoxyFilemanConf.UPLOAD,document.forms.addfile.submit();else alert(t("E_ActionDisabled"));else alert(t("E_SelectFiles"))}},e[t("Cancel")]=function(){$("#dlgAddFile").dialog("close")},$("#dlgAddFile").dialog({title:t("T_AddFile"),modal:!0,buttons:e,width:400})}function renameDir(){var e=getSelectedDir();if(e)if($('[data-path="'+e.fullPath+'"]').parents("li").length<1)alert(t("E_CannotRenameRoot"));else{clickFirstOnEnter("pnlDirName"),$("#txtDirName").val(e.name);var i={};i[t("RenameDir")]=function(){var i=$.trim($("#txtDirName").val());i||alert(t("E_MissingDirName")),e.Rename(i)&&$("#pnlDirName").dialog("close")},i[t("Cancel")]=function(){$("#pnlDirName").dialog("close")},$("#pnlDirName").dialog({title:t("T_RenameDir"),modal:!0,buttons:i}),RoxyUtils.SelectText("txtDirName",0,new String(e.name).length)}}function renameFile(){var e=getSelectedFile();if(e){clickFirstOnEnter("pnlRenameFile"),$("#txtFileName").val(e.name);var i={};i[t("RenameFile")]=function(){var t=$.trim($("#txtFileName").val());t?e.Rename(t)&&($('li[data-path="'+e.fullPath+'"] .name').text(t),$('li[data-path="'+e.fullPath+'"]').attr("data-path",RoxyUtils.MakePath(e.path,t)),$("#pnlRenameFile").dialog("close")):alert("Missing file name")},i[t("Cancel")]=function(){$("#pnlRenameFile").dialog("close")},$("#pnlRenameFile").dialog({title:t("T_RenameFile"),modal:!0,buttons:i}),e.name.lastIndexOf(".")>0&&RoxyUtils.SelectText("txtFileName",0,e.name.lastIndexOf("."))}}function getSelectedFile(){var e=null;return $("#pnlFileList .selected").length>0&&(e=new File($("#pnlFileList .selected").attr("data-path"))),e}function getSelectedDir(){var e=null;return $("#pnlDirList .selected")&&(e=Directory.Parse($("#pnlDirList .selected").closest("li").attr("data-path"))),e}function deleteDir(e){var i=null;(i=e?Directory.Parse(e):getSelectedDir())&&confirm(t("Q_DeleteFolder"))&&i.Delete()}function deleteFile(){var e=getSelectedFile();e&&confirm(t("Q_DeleteFile"))&&e.Delete()}function previewFile(){var e=getSelectedFile();e&&window.open(e.fullPath)}function downloadFile(){var e=getSelectedFile();if(e&&RoxyFilemanConf.DOWNLOAD){var i=RoxyUtils.AddParam(RoxyFilemanConf.DOWNLOAD,"f",e.fullPath);console.log(i),window.frames.frmUploadFile.location.href=i}else RoxyFilemanConf.DOWNLOAD||alert(t("E_ActionDisabled"))}function downloadDir(){var e=getSelectedDir();if(e&&RoxyFilemanConf.DOWNLOADDIR){var i=RoxyUtils.AddParam(RoxyFilemanConf.DOWNLOADDIR,"d",e.fullPath);console.log(i);var l=$("#frmUploadFile");l.length&&(l.src=i)}else RoxyFilemanConf.DOWNLOAD||alert(t("E_ActionDisabled"))}function closeMenus(e){e&&"dir"!=e||$("#menuDir").fadeOut(),e&&"file"!=e||$("#menuFile").fadeOut()}function selectFirst(){var e=$("#pnlDirList li:first").children("div").first();e.length>0?selectDir(e):window.setTimeout("selectFirst()",300)}function tooltipContent(){if($("#menuFile").is(":visible"))return"";var e="",i=File.Parse($(this).attr("data-path"));return"thumb"==$("#hdViewType").val()&&i.IsImage()?e=i.fullPath+'<br><span class="filesize">'+t("Size")+": "+RoxyUtils.FormatFileSize(i.size)+" "+t("Dimensions")+": "+i.width+"x"+i.height+"</span>":i.IsImage()?(RoxyFilemanConf.GENERATETHUMB?(imgUrl=RoxyUtils.AddParam(RoxyFilemanConf.GENERATETHUMB,"f",i.fullPath),imgUrl=RoxyUtils.AddParam(imgUrl,"width",RoxyFilemanConf.PREVIEW_THUMB_WIDTH),imgUrl=RoxyUtils.AddParam(imgUrl,"height",RoxyFilemanConf.PREVIEW_THUMB_HEIGHT)):imgUrl=i.fullPath,console.info(imgUrl),e='<img src="'+imgUrl+'" class="imgPreview"><br>'+i.name+' <br><span class="filesize">'+t("Size")+": "+RoxyUtils.FormatFileSize(i.size)+" "+t("Dimensions")+": "+i.width+"x"+i.height+"</span>"):e=RoxyUtils.GetFilename(i.fullPath)+' <span class="filesize">'+t("Size")+": "+RoxyUtils.FormatFileSize(i.size)+"</span>",e}function filterFiles(){var e=$("#txtSearch").val();if($("#pnlSearchNoFiles").hide(),0!=$("#pnlFileList li").length)if(e){var t=0;$("#pnlFileList li").each(function(){$(this).children(".name").text().toLowerCase().indexOf(e.toLowerCase())>-1?(t++,$(this).show()):($(this).removeClass("selected"),$(this).hide())}),0==t&&$("#pnlSearchNoFiles").show()}else $("#pnlFileList li").show()}function sortFiles(){var e=getSelectedDir();e&&(e.ListFiles(),filterFiles(),switchView($("#hdViewType").val()))}function switchView(e){if(e!=$("#hdViewType").val()){if(e||(e=$("#hdViewType").val()),$(".btnView").removeClass("selected"),"thumb"==e){if($("#pnlFileList .icon").attr("src","images/fileman/blank.gif"),$("#pnlFileList").addClass("thumbView"),0==$("#dynStyle").length){$("head").append('<style id="dynStyle" />');var t="ul#pnlFileList.thumbView li{width:"+RoxyFilemanConf.THUMBS_VIEW_WIDTH+"px;}";t+="ul#pnlFileList.thumbView li{height:"+(parseInt(RoxyFilemanConf.THUMBS_VIEW_HEIGHT)+20)+"px;}",t+="ul#pnlFileList.thumbView .icon{width:"+RoxyFilemanConf.THUMBS_VIEW_WIDTH+"px;}",t+="ul#pnlFileList.thumbView .icon{height:"+RoxyFilemanConf.THUMBS_VIEW_HEIGHT+"px;}",$("#dynStyle").html(t)}$("#pnlFileList li").each(function(){var e=$(this).attr("data-icon-big");RoxyFilemanConf.GENERATETHUMB&&RoxyUtils.IsImage($(this).attr("data-path"))&&(e=RoxyUtils.AddParam(RoxyFilemanConf.GENERATETHUMB,"f",e),e=RoxyUtils.AddParam(e,"width",RoxyFilemanConf.THUMBS_VIEW_WIDTH),e=RoxyUtils.AddParam(e,"height",RoxyFilemanConf.THUMBS_VIEW_HEIGHT)),$(this).children(".icon").css("background-image","url("+e+")"),$(this).tooltip("option","show",{delay:50})}),$("#btnThumbView").addClass("selected")}else $("#pnlFileList").removeClass("thumbView"),$("#pnlFileList li").each(function(){$(this).children(".icon").css("background-image","").attr("src",$(this).attr("data-icon")),$(this).tooltip("option","show",{delay:500})}),$("#btnListView").addClass("selected");$("#hdViewType").val(e),RoxyUtils.SetCookie("roxyview",e,10)}}var clipBoard=null;function Clipboard(e,t){this.action=e,this.obj=t}function cutDir(){var e=getSelectedDir();e&&(setClipboard("cut",e),e.GetElement().addClass("pale"))}function copyDir(){var e=getSelectedDir();e&&setClipboard("copy",e)}function cutFile(){var e=getSelectedFile();e&&(setClipboard("cut",e),e.GetElement().addClass("pale"))}function copyFile(){var e=getSelectedFile();e&&setClipboard("copy",e)}function pasteToFiles(e,t){if($(t).hasClass("pale"))return e.stopPropagation(),!1;var i=getSelectedDir();return i||(i=Directory.Parse($("#pnlDirList li:first").children("div").first())),i&&clipBoard&&clipBoard.obj&&("copy"==clipBoard.action?clipBoard.obj.Copy(i.fullPath):(clipBoard.obj.Move(i.fullPath),clearClipboard())),!0}function pasteToDirs(e,t){if($(t).hasClass("pale"))return e.stopPropagation(),!1;var i=getSelectedDir();return i||(i=Directory.Parse($("#pnlDirList li:first").children("div").first())),clipBoard&&i?"copy"==clipBoard.action?clipBoard.obj.Copy(i.fullPath):(clipBoard.obj.Move(i.fullPath),clearClipboard(),i.ListFiles(!0)):alert("error"),!0}function clearClipboard(){$("#pnlDirList li").removeClass("pale"),$("#pnlFileList li").removeClass("pale"),clipBoard=null,$(".paste").addClass("pale")}function setClipboard(e,t){clearClipboard(),t&&(clipBoard=new Clipboard(e,t),$(".paste").removeClass("pale"))}function ResizeLists(){var e=$(window).innerHeight()-$("#fileActions .actions").outerHeight()-$(".bottomLine").outerHeight();$(".scrollPane").css("height",e)}function removeDisabledActions(){""==RoxyFilemanConf.CREATEDIR&&($("#mnuCreateDir").next().remove(),$("#mnuCreateDir").remove(),$("#btnAddDir").remove()),""==RoxyFilemanConf.DELETEDIR&&($("#mnuDeleteDir").prev().remove(),$("#mnuDeleteDir").remove(),$("#btnDeleteDir").remove()),""==RoxyFilemanConf.MOVEDIR&&($("#mnuDirCut").next().remove(),$("#mnuDirCut").remove()),""==RoxyFilemanConf.COPYDIR&&($("#mnuDirCopy").next().remove(),$("#mnuDirCopy").remove()),""==RoxyFilemanConf.COPYDIR&&""==RoxyFilemanConf.MOVEDIR&&($("#mnuDirPaste").next().remove(),$("#mnuDirPaste").remove()),""==RoxyFilemanConf.RENAMEDIR&&($("#mnuRenameDir").next().remove(),$("#mnuRenameDir").remove(),$("#btnRenameDir").remove()),""==RoxyFilemanConf.UPLOAD&&$("#btnAddFile").remove(),""==RoxyFilemanConf.DOWNLOAD&&($("#mnuDownload").next().remove(),$("#mnuDownload").remove()),""==RoxyFilemanConf.DOWNLOADDIR&&($("#mnuDownloadDir").next().remove(),$("#mnuDownloadDir").remove()),""==RoxyFilemanConf.DELETEFILE&&($("#mnuDeleteFile").prev().remove(),$("#mnuDeleteFile").remove(),$("#btnDeleteFile").remove()),""==RoxyFilemanConf.MOVEFILE&&($("#mnuFileCut").next().remove(),$("#mnuFileCut").remove()),""==RoxyFilemanConf.COPYFILE&&($("#mnuFileCopy").next().remove(),$("#mnuFileCopy").remove()),""==RoxyFilemanConf.COPYFILE&&""==RoxyFilemanConf.MOVEFILE&&($("#mnuFilePaste").next().remove(),$("#mnuFilePaste").remove()),""==RoxyFilemanConf.RENAMEFILE&&($("#mnuRenameFile").next().remove(),$("#mnuRenameFile").remove(),$("#btnRenameFile").remove())}function getPreselectedFile(){var e=RoxyUtils.GetUrlParam("selected");if(!e)switch(getFilemanIntegration()){case"ckeditor":try{var t=window.opener.CKEDITOR.dialog.getCurrent();e=t.getValueOf("info","link"==t.getName()?"url":"txtUrl")}catch(e){}break;default:e=GetSelectedValue()}return e}function initSelection(e){var t=!1,i=!0;if(e||(e=getPreselectedFile()),!e&&RoxyUtils.ToBool(RoxyFilemanConf.OPEN_LAST_DIR)&&(e=getLastDir(),i=!1),e){var l=i?RoxyUtils.GetPath(e):e,a=tmp=Directory.Parse(l);do{tmp&&(tmp.Expand(!0),t=!0),tmp=Directory.Parse(tmp.path)}while(tmp);a&&(a.Select(e),t=!0)}t||selectFirst()}function getFilemanIntegration(){var e=RoxyUtils.GetUrlParam("integration");return e||(e=RoxyFilemanConf.INTEGRATION),e.toLowerCase()}function setFile(){var e=getSelectedFile();if(e){var i=e.fullPath;switch(getFilemanIntegration()){case"ckeditor":window.opener.CKEDITOR.tools.callFunction(RoxyUtils.GetUrlParam("CKEditorFuncNum"),i),self.close();break;default:FileSelected(e)}}else alert(t("E_NoFileSelected"))}$(function(){RoxyUtils.LoadConfig(),(new Directory).LoadAll(),$("#wraper").show(),window.setTimeout("initSelection()",100),RoxyUtils.Translate(),$("body").click(function(){closeMenus()});var e=RoxyUtils.GetCookie("roxyview");if(e||(e="list"),e&&switchView(e),ResizeLists(),$(".actions input").tooltip({track:!0}),$(window).resize(ResizeLists),document.oncontextmenu=function(){return!1},removeDisabledActions(),$("#copyYear").html((new Date).getFullYear()),RoxyFilemanConf.UPLOAD&&""!=RoxyFilemanConf.UPLOAD){var t=document.getElementById("fileActions");t.ondragover=function(){return!1},t.ondragend=function(){return!1},t.ondrop=function(e){e.preventDefault(),e.stopPropagation(),dropFiles(e)},(t=document.getElementById("dlgAddFile")).ondragover=function(){return!1},t.ondragend=function(){return!1},t.ondrop=function(e){e.preventDefault(),e.stopPropagation(),dropFiles(e,!0)}}});